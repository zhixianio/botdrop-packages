name: Build BotDrop Bootstrap (Source)

on:
  workflow_dispatch:
    inputs:
      arch:
        description: 'Architecture to build'
        required: true
        default: 'aarch64'
        type: choice
        options:
          - aarch64
          - arm
          - i686
          - x86_64
          - all

permissions:
  contents: write

concurrency:
  group: botdrop-bootstrap-src-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Bootstrap from Source
    runs-on: ubuntu-24.04
    timeout-minutes: 240

    steps:
      - name: Git clone
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Free up disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h /
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
          sudo rm -rf /usr/share/swift /usr/local/julia* /opt/hostedtoolcache
          sudo apt-get clean
          echo "=== Disk space after cleanup ==="
          df -h /

      - name: Determine architectures
        id: arch
        run: |
          ARCH="${{ inputs.arch || 'aarch64' }}"
          if [ "$ARCH" = "all" ]; then
            ARCH="aarch64,arm,i686,x86_64"
          fi
          echo "architectures=$ARCH" >> $GITHUB_OUTPUT
          echo "Building for architectures: $ARCH"

      - name: Verify package name configuration
        run: |
          echo "=== Checking TERMUX_APP__PACKAGE_NAME ==="
          grep 'TERMUX_APP__PACKAGE_NAME=' scripts/properties.sh | head -5
          echo ""
          echo "Expected: app.botdrop"
          if grep -q 'TERMUX_APP__PACKAGE_NAME="app.botdrop"' scripts/properties.sh; then
            echo "OK: Package name is correctly set to app.botdrop"
          else
            echo "ERROR: Package name is NOT set to app.botdrop!"
            exit 1
          fi

      - name: Build bootstrap from source
        run: |
          echo "=== Building from SOURCE (not pre-built packages) ==="
          echo "This compiles all packages from scratch so app.botdrop prefix takes effect"
          echo ""

          # The build-owlia-bootstrap.sh wraps build-bootstraps.sh which
          # uses Docker via run-docker.sh. For CI, we run it directly.
          ./scripts/run-docker.sh ./scripts/build-owlia-bootstrap.sh \
            --architectures ${{ steps.arch.outputs.architectures }} \
            2>&1 | tee build.log

          echo ""
          echo "=== Generated files ==="
          ls -lh *.zip 2>/dev/null || echo "No zip files found in root"
          ls -lh output/*.zip 2>/dev/null || echo "No zip files found in output/"

      - name: Find bootstrap archives
        id: find
        run: |
          # Find the generated zip files (may be in root or output dir)
          ZIPS=$(find . -maxdepth 2 -name "*.zip" -type f | head -20)
          if [ -z "$ZIPS" ]; then
            echo "ERROR: No bootstrap zip files found!"
            find . -name "bootstrap*" -type f 2>/dev/null || true
            exit 1
          fi
          echo "Found zip files:"
          echo "$ZIPS"

          # Copy all zips to a known location
          mkdir -p ./dist
          for z in $ZIPS; do
            cp "$z" ./dist/
          done
          ls -lh ./dist/

      - name: Upload bootstrap archive
        uses: actions/upload-artifact@v4
        with:
          name: botdrop-bootstrap-src-${{ steps.arch.outputs.architectures }}
          path: "dist/*.zip"
          retention-days: 30
          if-no-files-found: error

      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-log-source
          path: "build.log"
          retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-24.04

    steps:
      - name: Git clone
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: botdrop-bootstrap-src-*
          merge-multiple: true
          path: ./bootstraps

      - name: List downloaded files
        run: |
          echo "Downloaded bootstrap files:"
          ls -lhR ./bootstraps/

      - name: Generate release tag
        id: tag
        run: |
          DATE_TAG="bootstrap-$(date '+%Y.%m.%d')"

          git fetch --tags
          EXISTING=$(git tag -l "${DATE_TAG}-r*+botdrop" | sort -V | tail -1 || true)

          if [ -n "$EXISTING" ]; then
            REV=$(echo "$EXISTING" | grep -oP 'r\K\d+' || echo "0")
            NEW_REV=$((REV + 1))
          else
            NEW_REV=1
          fi

          TAG_NAME="${DATE_TAG}-r${NEW_REV}+botdrop"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Generated tag: $TAG_NAME"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ steps.tag.outputs.tag_name }}"

          cat > release_notes.md << 'NOTES'
          ## BotDrop Bootstrap Archives (Source Build)

          Custom bootstrap archives built **from source** with `app.botdrop` package prefix.

          These archives have all packages compiled with the correct package name,
          unlike the fast-mode builds which use pre-built `com.termux` packages.

          ### Included packages:
          - **nodejs-lts** - Node.js LTS runtime + npm
          - **git** - Git version control
          - **openssh** - SSH client and server
          - **openssl** - OpenSSL tools
          - **termux-api** - Termux:API interface
          - **proot** - proot for /tmp support

          ### Package prefix: `app.botdrop`
          NOTES

          gh release create "$TAG_NAME" \
            --title "BotDrop Bootstrap (Source) $TAG_NAME" \
            --notes-file release_notes.md \
            --target feature/app-botdrop-prefix \
            ./bootstraps/*.zip

      - name: Summary
        run: |
          echo "## Bootstrap Source Build Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release Tag:** ${{ steps.tag.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Package Prefix:** app.botdrop" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type:** Source (compiled from scratch)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          for f in ./bootstraps/*.zip; do
            SIZE=$(du -h "$f" | cut -f1)
            echo "- \`$(basename $f)\` ($SIZE)" >> $GITHUB_STEP_SUMMARY
          done
